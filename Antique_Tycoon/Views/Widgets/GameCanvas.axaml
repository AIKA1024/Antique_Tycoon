<UserControl
  x:Class="Antique_Tycoon.Views.Widgets.GameCanvas"
  xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:c="using:Antique_Tycoon.Views.Controls"
  xmlns:cv="using:Antique_Tycoon.Converters"
  xmlns:i="using:Antique_Tycoon.Behaviors"
  xmlns:cm="using:Antique_Tycoon.Models.Connections"
  xmlns:widgets="clr-namespace:Antique_Tycoon.Views.Widgets"
  xmlns:nodes="clr-namespace:Antique_Tycoon.Models.Nodes"
  ClipToBounds="False"
  x:Name="Me"
  Focusable="True">
  <Design.PreviewWith>
    <widgets:GameCanvas />
  </Design.PreviewWith>
  <Panel Background="{DynamicResource BorderBackgroundColor}">
    <c:XListBox
      x:Name="EntityListBox"
      Background="{x:Null}"
      ClipToBounds="False"
      ItemsSource="{Binding #Me.CurrentMap.Entities}"
      RenderTransformOrigin="0,0"
      SelectedItem="{Binding #Me.SelectedMapEntity, Mode=OneWayToSource}"
      SelectedItems="{Binding #Me.SelectedMapEntities,Mode=TwoWay}"
      SelectionMode="Multiple">
      <c:XListBox.RenderTransform>
        <TransformGroup>
          <ScaleTransform ScaleX="{Binding #Me.CurrentMap.Scale}" ScaleY="{Binding #Me.CurrentMap.Scale}" />
          <TranslateTransform X="{Binding #Me.CurrentMap.Offset.X}" Y="{Binding #Me.CurrentMap.Offset.Y}" />
        </TransformGroup>
      </c:XListBox.RenderTransform>
      <c:XListBox.DataTemplates>
        <DataTemplate DataType="nodes:NodeModel">
          <!-- 设置top和Left是为了触发CanvasItemDragBehavior的监听，因为和listboxItem的top和left绑定的是相同的对象，所以变相监听到了listboxItem的top和left -->
          <c:NodeLinkControl
            Canvas.Top="{Binding Top}"
            Canvas.Left="{Binding Left}"
            Focusable="True"
            Content="{Binding $self.DataContext}"
            Map="{Binding #Me.CurrentMap, RelativeSource={RelativeSource AncestorType=c:XListBox}}">
            <c:NodeLinkControl.DataTemplates>
              <StaticResource ResourceKey="SpawnPointDataTemplate" />
              <StaticResource ResourceKey="EstateDataTemplate" />
              <StaticResource ResourceKey="MineDataTemplate" />
            </c:NodeLinkControl.DataTemplates>
          </c:NodeLinkControl>
        </DataTemplate>

        <DataTemplate DataType="cm:Connection">
          <c:ConnectionLine Data="{Binding Data}" Stroke="{Binding Stroke}"
                            StrokeThickness="{Binding StrokeThickness}"
                            StartPoint="{Binding StartConnectorAnchor}"
                            EndPoint="{Binding EndConnectorAnchor}" />
        </DataTemplate>
      </c:XListBox.DataTemplates>
      <c:XListBox.ItemsPanel>
        <ItemsPanelTemplate>
          <Canvas
            ClipToBounds="False"
            PointerReleased="InputElement_OnPointerReleased"
            Width="{Binding #Me.CurrentMap.CanvasWidth}"
            Height="{Binding #Me.CurrentMap.CanvasHeight}"
            Background="{Binding #Me.CurrentMap.CanvasBackground, Converter={x:Static cv:SolidBrushAndColorConverter.ToSolidBrush}}">
            <!-- 这个也可以放给行为来添加 -->
            
          </Canvas>
        </ItemsPanelTemplate>
      </c:XListBox.ItemsPanel>
      <c:XListBox.Styles>
        <Style Selector="c|XListBox">
          <Setter Property="Template">
            <ControlTemplate>
              <Border
                Background="{TemplateBinding Background}"
                BorderBrush="{TemplateBinding BorderBrush}"
                BorderThickness="{TemplateBinding BorderThickness}"
                ClipToBounds="{TemplateBinding ClipToBounds}"
                CornerRadius="{TemplateBinding CornerRadius}">
                <ItemsPresenter
                  x:Name="PART_ItemsPresenter"
                  Margin="{TemplateBinding Padding}"
                  ItemsPanel="{TemplateBinding ItemsPanel}" />
              </Border>
            </ControlTemplate>
          </Setter>
        </Style>

        <Style Selector="c|XListBoxItem" x:DataType="nodes:CanvasItemModel">
          <Setter Property="ZIndex" Value="{Binding ZIndex,Mode=TwoWay}" />
          <Setter Property="i:DataContextType.Type" Value="{Binding}" />
          <Setter Property="Template">
            <ControlTemplate>
              <ContentPresenter Content="{TemplateBinding Content}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                ZIndex="{TemplateBinding ZIndex}" />
            </ControlTemplate>
          </Setter>
        </Style>
        <Style x:DataType="nodes:NodeModel" Selector="c|XListBoxItem.NodeModel">
          <Setter Property="i:Tap.Command" Value="{Binding #Me.NodeClickedCommand}" />
          <Setter Property="i:Tap.CommandParameter" Value="{Binding Uuid}" />
          <Setter Property="Background" Value="Transparent" />
          <Setter Property="Canvas.Top" Value="{Binding Top}" />
          <Setter Property="Canvas.Left" Value="{Binding Left}" />
          <Style Selector="^:selected">
            <Setter Property="ZIndex" Value="2" />
            <Style Selector="^ /template/ ContentPresenter>c|NodeLinkControl">
              <Setter Property="BorderBrush" Value="{StaticResource NodeSelectedBrush}" />
            </Style>
          </Style>
        </Style>
        <!-- <Style x:DataType="cm:Connection" Selector="c|XListBoxItem.Connection"> -->
        <!--    -->
        <!-- </Style> -->
      </c:XListBox.Styles>
    </c:XListBox>
    <Interaction.Behaviors>
      <i:ZoomPanBehavior Scale="{Binding #Me.CurrentMap.Scale, Mode=TwoWay}"
                         Offset="{Binding #Me.CurrentMap.Offset, Mode=TwoWay}" />
    </Interaction.Behaviors>
  </Panel>

</UserControl>